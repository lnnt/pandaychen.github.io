---
layout:     post
title:      重拾 Linux 网络（四）：NAT
subtitle:
date:       2023-09-02
author:     pandaychen
catalog:    true
tags:
    - network
    - NAT
---


##  Ox00    前言
NAT（Network Address Translation，网络地址转换），也叫做网络掩蔽或者 IP 掩蔽。NAT 是一种网络地址翻译技术，主要是将内部的私有 IP 地址（private IP）转换成可以在公网使用的公网 IP（public IP）

本文介绍下笔者在项目中解决 UDP 透明代理的 NAT 实现及相关背景知识。

NAT 分为两类：
-   基础 NAT：网络地址转换（Network Address Translation）
-   NAPT：网络地址端口转换（Network Address Port Translation）

####    基础 NAT
基础 NAT 仅对网络地址进行转换，要求对每一个当前连接都要对应一个公网 IP 地址，所以需要有一个公网 IP 池；基础 NAT 内部有一张 NAT 表以记录对应 IP 映射关系

####    NAPT
NAPT 需要对网络地址和端口进行转换，这种类型允许多台主机共用一个公网 IP 地址，NAPT 内部同样有一张 NAT 表，并标注了端口，以记录对应关系，如下：

| 内网 ip | 外网 ip |
| :-----:| :----: |
| 192.168.1.1:1025 |1.2.3.4:1025 |
| 192.168.1.1:3333 |1.2.3.5:10000 |
| 192.168.1.12:7788 |1.2.3.6:32556|

本文主要讨论 NAPT 相关内容

##  0x01    NAPT

NAPT 分类如下：

-   完全锥型
-   受限锥型
-   端口受限锥
-   对称型

####    完全锥型
从同一个内网地址端口 `192.168.1.1:7777` 发起的请求都由 NAT 转换成公网地址端口 `1.2.3.4:10000`；反方向，`192.168.1.1:7777` 可以收到任意外部主机发到 `1.2.3.4:10000` 的数据包

![]()

####    受限锥型
受限锥型也称地址受限锥型，在完全锥型的基础上，对 ip 地址进行了限制；从同一个内网地址端口 `192.168.1.1:7777` 发起的请求都由 NAT 转换成公网地址端口 `1.2.3.4:10000`，其访问的服务器为 `8.8.8.8:123`，只有当 `192.168.1.1:7777` 向 `8.8.8.8:123` 发送一个报文后，`192.168.1.1:7777` 才可以收到 `8.8.8.8` 发回 `1.2.3.4:10000` 的报文

![]()

####    端口受限锥型
在受限锥型的基础上，对端口也进行了限制；从同一个内网地址端口 `192.168.1.1:7777` 发起的请求都由 NAT 转换成公网地址端口 `1.2.3.4:10000`，其访问的服务器为 `8.8.8.8:123`，只有当 `192.168.1.1:7777` 向 `8.8.8.8:123` 发送一个报文后，`192.168.1.1:7777` 才可以收到 `8.8.8.8:123` 发回 `1.2.3.4:10000` 的报文

![]()

####    对称型
在对称型 NAT 中，只有来自于同一个内网地址端口 、且针对同一目标地址端口的请求才被 NAT 转换至同一个公网地址端口，否则的话，NAT 将为之分配一个新的公网地址端口。内网地址端口 `192.168.1.1:7777` 发起请求到 `8.8.8.8:123`，由 NAT 转换成公网地址端口 `1.2.3.4:10000`，随后内网地址端口 `192.168.1.1:7777` 又发起请求到 `9.9.9.9:456`，NAT 将分配新的公网地址端口 `1.2.3.4:10001`

小结下：在 锥型 NAT 中，映射关系和目标地址端口无关，而在对称型 NAT 中则与目标地址端口有关。** 锥型 NAT 正因为其于目标地址端口无关，所以网络拓扑是圆锥型的 **

![symmetric-nat]()


##  0x02 NAT 的工作流程


##  0x03    NAT 类型检测



##  0x04    UDP 打洞


##  0x05    总结

最后，回顾下 NAT 的类型及检测方法：

| 类型 | NAT 说明 | 检测方法 |
| :-----:| :----: | :----: |
| Symmetric NAT（对称 NAT） | 在 Symmetric NAT 中，NAT 设备会为每个内部 IP 地址和端口号分配一个唯一的公共 IP 地址和端口号，但是对于不同的目的 IP 地址和端口号，NAT 设备会为其分配不同的公共 IP 地址和端口号。这意味着，对于同一个内部主机，向不同的目的主机发送数据包时，NAT 设备会将其映射到不同的内部 IP 地址和端口号 | 使用 STUN 协议，向外部服务器发送 UDP 数据包，如果返回的数据包中包含了本地 IP 地址和端口号，并且数据包的源 IP 地址和端口号与之前发送的数据包不同，则表示是 Symmetric NAT |
|  |  |  |

##  0x04 参考
-   [NAT 原理以及 UDP 穿透](https://paper.seebug.org/1561/)
-   [进阶必读：代理协议 UDP 全方位透彻解析](https://zhuanlan.zhihu.com/p/518088166)